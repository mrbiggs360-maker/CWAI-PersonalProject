<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CWAI 1.2.5.1 | Neural Interface</title>
    <link rel="manifest" href="./manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' },
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: {
                        'enter-message': 'slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-in': 'slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        slideUpFade: {
                            '0%': { opacity: 0, transform: 'translateY(10px) scale(0.98)' },
                            '100%': { opacity: 1, transform: 'translateY(0) scale(1)' },
                        },
                        slideInRight: {
                            '0%': { opacity: 0, transform: 'translateX(10px)' },
                            '100%': { opacity: 1, transform: 'translateX(0)' },
                        },
                        popIn: {
                            '0%': { opacity: 0, transform: 'scale(0.9)' },
                            '100%': { opacity: 1, transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --app-bg: #050505; }
        body { background-color: var(--app-bg); color: #e5e7eb; font-family: 'Inter', sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        
        .prose { font-size: 0.95rem; line-height: 1.6; max-width: none; color: #d1d5db; }
        .prose pre { background: #161b22 !important; border-radius: 0.5rem; padding: 0.8rem; margin: 0.8rem 0; border: 1px solid #30363d; overflow-x: auto; position: relative; }
        .prose code { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; background: rgba(255,255,255,0.08); padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
        
        .glass { background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .glass-heavy { background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        
        .msg-user { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border-radius: 18px 18px 4px 18px; }
        .msg-ai { background-color: transparent; color: #e5e7eb; border-radius: 18px 18px 18px 4px; }
        
        #control-panel { transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        #control-panel.closed { transform: translateX(100%); opacity: 0; pointer-events: none; }
        #control-panel.open { transform: translateX(0); opacity: 1; pointer-events: auto; }
        
        .copy-code-btn { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 0.7rem; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 4px; color: #aaa; cursor: pointer; opacity: 0; transition: 0.2s; }
        .prose pre:hover .copy-code-btn { opacity: 1; }

        .loader-bar-bg { overflow: hidden; position: relative; }
        .loader-bar-bg::after { content:''; position: absolute; top:0; left:0; bottom:0; right:0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transform: translateX(-100%); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative bg-black selection:bg-blue-500/30 selection:text-blue-200">

    <div id="main-header" class="fixed top-0 left-0 right-0 h-14 glass z-20 flex items-center justify-between px-4 border-b border-gray-800 transition-transform duration-300">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-2xl bg-gradient-to-b from-blue-600 to-blue-700 flex items-center justify-center shadow-lg shadow-blue-900/40 cursor-pointer hover:scale-105 transition-transform duration-300" onclick="togglePanel(true)">
                 <svg viewBox="0 0 100 100" class="w-6 h-6 text-white drop-shadow-md" fill="none" stroke="currentColor" stroke-width="8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M50 85 C40 85 25 75 25 55 C25 35 35 25 45 25 C35 25 30 35 30 45" />
                    <path d="M50 85 C60 85 75 75 75 55 C75 35 65 25 55 25 C65 25 70 35 70 45" />
                    <path d="M45 25 C50 25 50 45 35 55" />
                    <path d="M55 25 C50 25 50 45 65 55" />
                </svg>
            </div>
            <div>
                <h1 class="text-sm font-bold text-gray-100 tracking-tight leading-none">CWAI 1.2.5.1</h1>
                <div id="header-model-status" class="text-[10px] text-gray-400 flex items-center gap-1 cursor-pointer hover:text-blue-400 transition mt-0.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]" id="status-dot"></span>
                    <span id="current-model-name">No Model Loaded</span>
                </div>
            </div>
        </div>
        <div class="flex gap-1">
            <button id="header-focus-btn" class="text-gray-400 hover:text-white h-9 w-9 rounded-full hover:bg-gray-800/50 flex items-center justify-center transition" title="Focus Mode"><i class="ri-fullscreen-line"></i></button>
            <button id="header-menu-btn" class="text-gray-400 hover:text-white h-9 w-9 rounded-full hover:bg-gray-800/50 flex items-center justify-center transition" title="Settings"><i class="ri-settings-4-line text-lg"></i></button>
        </div>
    </div>

    <button id="focus-exit-btn" class="hidden fixed top-4 right-4 z-50 bg-black/50 hover:bg-red-900/80 text-gray-300 hover:text-white px-4 py-1.5 rounded-full text-xs font-medium backdrop-blur-md transition border border-gray-700 shadow-xl flex items-center gap-2">
        <i class="ri-fullscreen-exit-line"></i> Exit Focus
    </button>

    <div id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-36 px-4 md:px-0 max-w-3xl mx-auto w-full space-y-6 custom-scroll scroll-smooth">
        <div id="welcome-message" class="flex flex-col items-center justify-center h-[60vh] text-gray-600 fade-in">
            <div class="w-20 h-20 rounded-2xl bg-gray-900 border border-gray-800 flex items-center justify-center mb-6 shadow-2xl rotate-3 hover:rotate-0 transition duration-500 group">
                 <i class="ri-cpu-line text-5xl text-gray-700 group-hover:text-blue-500 transition-colors"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-300 mb-2">Neural Interface Ready</h2>
            <p class="text-sm font-mono text-gray-500 text-center max-w-xs" id="ram-welcome-msg">Detecting Hardware...</p>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 glass-heavy border-t border-gray-800 p-3 pb-5 z-20">
        <div class="max-w-3xl mx-auto flex flex-col gap-3">
            <div class="flex justify-center gap-6 pb-1 opacity-60 hover:opacity-100 transition duration-300">
                <button onclick="quickAction('Suggest a creative idea')" class="text-[10px] text-gray-400 hover:text-purple-400 uppercase font-bold tracking-widest flex items-center gap-1.5"><i class="ri-lightbulb-flash-line"></i> Idea</button>
                <button onclick="quickAction('Improve the text above')" class="text-[10px] text-gray-400 hover:text-blue-400 uppercase font-bold tracking-widest flex items-center gap-1.5"><i class="ri-edit-circle-line"></i> Refine</button>
                <button onclick="quickAction('Continue the story')" class="text-[10px] text-gray-400 hover:text-green-400 uppercase font-bold tracking-widest flex items-center gap-1.5"><i class="ri-arrow-right-circle-line"></i> Next</button>
            </div>

            <div class="flex items-end gap-2 relative bg-gray-900/80 p-1.5 rounded-[24px] border border-gray-800 shadow-xl ring-1 ring-white/5 focus-within:ring-blue-500/50 focus-within:border-blue-500/50 transition-all duration-300">
                <button id="mic-btn" class="h-10 w-10 rounded-full text-gray-400 hover:text-white hover:bg-gray-800 flex items-center justify-center shrink-0 transition"><i class="ri-mic-line text-lg"></i></button>
                <textarea id="user-input" rows="1" class="w-full bg-transparent text-gray-100 px-2 py-2.5 focus:outline-none resize-none overflow-hidden max-h-48 text-sm placeholder-gray-600 font-medium" placeholder="Message System..."></textarea>
                <button id="send-btn" class="h-10 w-10 rounded-full bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center shrink-0 shadow-lg shadow-blue-900/20 transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50">
                    <i class="ri-arrow-up-line text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="floating-menu" class="fixed bottom-36 right-6 z-30 flex flex-col items-end gap-3 pointer-events-none">
        <div id="floating-items" class="flex flex-col gap-3 items-end mb-2 transition-all duration-300 opacity-0 translate-y-4 pointer-events-none scale-95 origin-bottom-right">
            <button id="float-new-btn" class="bg-gray-800 hover:bg-gray-700 text-gray-200 p-2 rounded-full shadow-lg border border-gray-700 w-11 h-11 flex items-center justify-center pointer-events-auto transition hover:scale-110" title="New Chat"><i class="ri-chat-new-line text-lg"></i></button>
            <button id="float-voice-btn" class="bg-gray-800 hover:bg-gray-700 text-gray-200 p-2 rounded-full shadow-lg border border-gray-700 w-11 h-11 flex items-center justify-center pointer-events-auto transition hover:scale-110" title="Toggle Voice"><i class="ri-volume-mute-line text-lg" id="float-voice-icon"></i></button>
        </div>
        <button id="float-toggle-btn" class="bg-blue-600 hover:bg-blue-500 text-white w-14 h-14 rounded-full shadow-2xl shadow-blue-900/50 flex items-center justify-center transition-all hover:scale-110 active:scale-95 pointer-events-auto group border border-blue-400/30">
            <i class="ri-add-line text-3xl transition-transform duration-300 group-hover:rotate-90"></i>
        </button>
    </div>

    <div id="panel-backdrop" class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm hidden transition-opacity duration-300" onclick="togglePanel(false)"></div>
    <div id="control-panel" class="fixed top-0 right-0 bottom-0 w-full max-w-[400px] z-50 bg-gray-950 border-l border-gray-800 shadow-2xl flex flex-col closed">
        
        <div class="flex items-center justify-between px-6 py-5 shrink-0 border-b border-gray-900 bg-gray-950">
            <h2 class="text-lg font-bold text-gray-100 flex items-center gap-2">Control Center</h2>
            <button onclick="togglePanel(false)" class="text-gray-500 hover:text-white bg-gray-900 hover:bg-gray-800 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="ri-close-line text-xl"></i></button>
        </div>

        <div class="flex items-center px-4 border-b border-gray-900 gap-1 text-xs font-medium mt-2 shrink-0 overflow-x-auto no-scrollbar">
            <button class="tab-btn flex-1 py-3 text-center rounded-t-lg transition relative text-blue-400 active-tab" data-tab="models">Models</button>
            <button class="tab-btn flex-1 py-3 text-center rounded-t-lg transition relative text-gray-500 hover:text-gray-300" data-tab="lore">Lore</button>
            <button class="tab-btn flex-1 py-3 text-center rounded-t-lg transition relative text-gray-500 hover:text-gray-300" data-tab="data">Sessions</button>
            <button class="tab-btn flex-1 py-3 text-center rounded-t-lg transition relative text-gray-500 hover:text-gray-300" data-tab="system">System</button>
        </div>

        <div id="panel-content" class="flex-1 overflow-y-auto p-5 custom-scroll relative">
            
            <div id="tab-models" class="space-y-6 animate-slide-in">
                <div class="bg-gray-900/40 rounded-xl p-4 border border-gray-800 hover:border-gray-700 transition">
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="ri-cloud-line"></i> Cloud API</h3>
                    <div class="space-y-3 relative">
                        <input type="password" id="cloud-key-primary" oninput="detectAndFill(this.value)" class="w-full bg-black/50 border border-gray-800 rounded-lg p-2.5 text-xs text-white font-mono focus:border-blue-500 outline-none transition" placeholder="Primary API Key (Paste here to auto-detect)">
                        <input type="password" id="cloud-key-backup" class="w-full bg-black/50 border border-gray-800 rounded-lg p-2.5 text-xs text-white font-mono focus:border-blue-500 outline-none transition" placeholder="Backup API Key (Fallback)">
                        
                        <div class="relative group">
                             <input type="text" id="cloud-endpoint" class="w-full bg-black/50 border border-gray-800 rounded-lg p-2.5 text-xs text-blue-200 font-mono focus:border-blue-500 outline-none transition" placeholder="API Endpoint URL (Auto-filled)">
                             <div class="absolute right-3 top-2.5 text-gray-600 text-[10px] pointer-events-none group-focus-within:text-blue-500">URL</div>
                        </div>

                        <div class="relative">
                            <input type="text" id="cloud-model-id" onfocus="showModelSuggestions(true)" onblur="setTimeout(()=>showModelSuggestions(false), 200)" class="w-full bg-black/50 border border-gray-800 rounded-lg p-2.5 text-xs text-white font-mono focus:border-blue-500 outline-none transition" placeholder="Model ID (e.g. google/gemini-2.0-flash)">
                            <div id="model-suggestions" class="hidden absolute top-full left-0 right-0 mt-1 bg-gray-900 border border-gray-700 rounded-lg shadow-xl z-20 max-h-40 overflow-y-auto custom-scroll">
                                </div>
                        </div>
                        
                        <div class="flex items-center justify-between pt-2">
                            <span class="text-xs text-gray-400">Auto-Detect Provider</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-detect-toggle" class="sr-only peer" checked>
                                <div class="w-10 h-5 bg-gray-800 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
                            </label>
                        </div>
                        <button id="activate-cloud-btn" class="w-full py-2.5 bg-blue-600/10 border border-blue-600/30 text-blue-400 text-xs font-bold rounded-lg hover:bg-blue-600 hover:text-white transition">Use Cloud Model</button>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-3 px-1">
                        <h3 class="text-xs font-bold text-green-500 uppercase tracking-wider flex items-center gap-2"><i class="ri-hard-drive-2-line"></i> Local (WebLLM)</h3>
                        <span id="ram-badge" class="text-[9px] bg-gray-900 text-gray-500 px-2 py-1 rounded border border-gray-800 font-mono">Checking RAM...</span>
                    </div>
                    <div id="offline-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="tab-lore" class="hidden space-y-4">
                 <div class="bg-gray-900/40 rounded-xl p-4 border border-gray-800">
                    <h3 class="text-xs font-bold text-purple-400 uppercase tracking-wider mb-3" id="lore-header-text">Create Persona Card</h3>
                    <input id="lore-name-input" type="text" placeholder="Character Name" class="w-full bg-black/50 border border-gray-800 rounded-lg p-2.5 text-xs text-white mb-2 focus:border-purple-500 outline-none">
                    <textarea id="lore-desc-input" placeholder="Details (Personality, Appearance, Secret)" class="w-full bg-black/50 border border-gray-800 rounded-lg p-2.5 text-xs text-white h-24 resize-none focus:border-purple-500 outline-none mb-3"></textarea>
                    <div class="flex gap-2">
                        <button id="cancel-lore-btn" class="hidden w-1/3 py-2 bg-gray-800 border border-gray-700 text-gray-400 text-xs font-bold rounded-lg hover:bg-gray-700 transition">Cancel</button>
                        <button id="add-lore-btn" class="flex-1 py-2 bg-purple-600/10 border border-purple-600/30 text-purple-400 text-xs font-bold rounded-lg hover:bg-purple-600 hover:text-white transition">Add to Context</button>
                    </div>
                </div>
                <div id="lore-list" class="space-y-2 pb-4"></div>
            </div>

            <div id="tab-data" class="hidden space-y-4">
                <div class="relative">
                    <i class="ri-search-line absolute left-3 top-2.5 text-gray-500 text-sm"></i>
                    <input type="text" id="session-search" placeholder="Filter chats..." class="w-full bg-gray-900 border border-gray-800 rounded-lg pl-9 pr-3 py-2 text-sm text-gray-300 focus:border-blue-500 outline-none transition">
                </div>
                <div class="bg-gray-900/30 rounded-xl p-2 border border-gray-800 min-h-[250px]">
                    <div id="session-list" class="max-h-[350px] overflow-y-auto space-y-1 p-1 custom-scroll"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button id="load-presets-btn" class="bg-indigo-900/20 hover:bg-indigo-900/40 text-indigo-300 py-3 rounded-xl text-xs font-medium border border-indigo-500/20 flex flex-col items-center gap-1 transition"><i class="ri-book-read-line text-lg"></i> Examples</button>
                    <button id="export-btn" class="bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl text-xs font-medium border border-gray-700 flex flex-col items-center gap-1 transition"><i class="ri-upload-2-line text-lg"></i> Backup</button>
                </div>
                <button id="import-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl text-xs font-medium border border-gray-700 flex items-center justify-center gap-2 transition"><i class="ri-download-2-line text-lg"></i> Restore Backup</button>
            </div>
            
            <div id="tab-system" class="hidden space-y-6">
                <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-400 text-xs font-bold uppercase tracking-wider">Context Limit</span>
                        <span id="ctx-label" class="text-blue-400 font-mono font-bold text-xs">SAFE</span>
                    </div>
                    <input type="range" id="ctx-slider" min="0" max="2" step="1" value="1" class="w-full h-1.5 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-blue-600 mb-2">
                    <div class="flex justify-between text-[9px] text-gray-500 font-mono mb-3"><span>MINIMAL</span><span>SAFE</span><span>ULTIMATE</span></div>
                    <p id="ctx-desc" class="text-[11px] text-gray-500 leading-relaxed border-t border-gray-800 pt-3">Safe 'Sweet Spot'. 4k tokens. Recommended.</p>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wide">System Persona</label>
                    <textarea id="system-prompt-input" class="w-full h-40 bg-gray-900 border border-gray-800 rounded-xl p-3 text-xs text-gray-300 focus:border-blue-500 outline-none resize-none font-mono leading-relaxed custom-scroll" placeholder="You are a helpful AI assistant..."></textarea>
                </div>
                <div class="space-y-3 bg-gray-900/40 p-4 rounded-xl border border-gray-800">
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-400 uppercase font-semibold">Temperature</span>
                        <span id="temp-val" class="text-blue-400 font-mono">0.7</span>
                    </div>
                    <input type="range" id="temp-slider" min="0" max="1" step="0.1" value="0.7" class="w-full h-1.5 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
                <button id="wipe-data-btn" class="w-full py-3 text-xs text-red-400 border border-red-900/30 bg-red-900/10 rounded-xl hover:bg-red-900/20 transition font-bold uppercase tracking-wider">Reset App Data</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-8 hidden text-center backdrop-blur-xl transition-opacity duration-300">
        <div class="w-16 h-16 border-2 border-gray-800 border-t-blue-500 rounded-full animate-spin mb-6"></div>
        <h2 class="text-2xl font-bold text-white mb-2 tracking-tight" id="loader-title">Initializing</h2>
        <p class="text-gray-400 text-sm max-w-xs mb-8" id="loader-text">Please wait...</p>
        <div class="w-64 bg-gray-800 rounded-full h-1.5 overflow-hidden loader-bar-bg"><div id="loader-bar" class="bg-blue-500 h-full transition-all duration-300 w-0 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div></div>
        <button id="cancel-load-btn" class="mt-8 text-gray-500 hover:text-white text-xs uppercase tracking-widest font-bold">Cancel</button>
    </div>

    <div id="import-modal" class="hidden fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm animate-pop-in">
        <div class="bg-gray-950 p-6 rounded-2xl border border-gray-800 w-full max-w-lg shadow-2xl flex flex-col h-[500px]">
            <h3 class="text-white font-bold mb-4 text-lg">Import Data</h3>
            <textarea id="import-area" class="flex-1 w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-xs text-gray-300 font-mono resize-none focus:border-blue-500 mb-4 outline-none" placeholder="Paste your backup JSON string here..."></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('import-modal').classList.add('hidden')" class="px-5 py-2.5 text-gray-400 text-xs font-bold rounded-lg hover:text-white transition">Cancel</button>
                <button id="confirm-import-btn" class="px-6 py-2.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-500 shadow-lg shadow-blue-900/20 transition">Load Data</button>
            </div>
        </div>
    </div>

    <div id="update-toast" class="fixed bottom-6 right-6 z-[120] translate-y-20 opacity-0 pointer-events-none transition-all duration-500 ease-out">
        <div class="bg-gray-900/95 border border-blue-500/30 p-4 rounded-xl shadow-2xl backdrop-blur-xl flex items-center gap-4 max-w-sm">
            <div class="bg-blue-600/20 p-2.5 rounded-full text-blue-400">
                <i class="ri-refresh-line text-xl animate-spin"></i>
            </div>
            <div>
                <h4 class="text-sm font-bold text-white">Update Available</h4>
                <p class="text-xs text-gray-400">New version ready to install.</p>
            </div>
            <button id="update-btn" class="ml-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg shadow-lg transition">
                Update
            </button>
        </div>
    </div>

    <div id="toast-container" class="fixed top-20 right-4 z-[110] flex flex-col gap-2 pointer-events-none"></div>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";
        import { get, set, del } from 'https://cdn.jsdelivr.net/npm/idb-keyval@6/+esm';

        // --- CONSTANTS ---
        const DB_KEY = 'cwai_1_2_5_db';
        const OFFLINE_MODELS = [
            { id: "TinyLlama-1.1B-Chat-v0.4-q4f32_1-MLC-1k", name: "TinyLlama 1.1B", reqRam: 2, tags: ["Fast", "Light"], limits: [1024, 2048, 2048] },
            { id: "gemma-2-2b-it-q4f32_1-MLC", name: "Gemma 2 2B", reqRam: 4, tags: ["Balanced", "Google"], limits: [2048, 4096, 8192] },
            { id: "Llama-3.2-3B-Instruct-q4f16_1-MLC", name: "Llama 3.2 3B", reqRam: 6, tags: ["Smart", "Meta"], limits: [2048, 4096, 128000] },
            { id: "Mistral-7B-Instruct-v0.3-q4f16_1-MLC", name: "Mistral 7B", reqRam: 8, tags: ["Creative", "Heavy"], limits: [2048, 4096, 32768] }
        ];

        // --- CLOUD PROVIDER DATA ---
        const CLOUD_PROVIDERS = {
            google: {
                url: "https://generativelanguage.googleapis.com/v1beta/models",
                models: [
                    "gemini-3.0-pro-preview-01", "gemini-2.5-flash-latest", "gemini-2.0-flash-lite-preview-02-05", 
                    "gemini-2.0-flash", "gemini-1.5-pro", "gemini-1.5-flash"
                ]
            },
            openrouter: {
                url: "https://openrouter.ai/api/v1/chat/completions",
                models: [
                    "google/gemini-2.0-flash-001", "anthropic/claude-3-opus", "meta-llama/llama-3-70b-instruct",
                    "deepseek/deepseek-r1"
                ]
            },
            deepseek: {
                url: "https://api.deepseek.com/chat/completions",
                models: ["deepseek-chat", "deepseek-coder"]
            }
        };

        let state = {
            sessions: {}, currentSessionId: null,
            cloud: { primary: "", backup: "", targetModel: "", endpoint: "", autoDetect: true },
            settings: { activeModelId: null, temperature: 0.7, tts: false, contextStrategy: 1 },
            downloadedModels: []
        };
        // ADDED: loadedModelId to track what is currently in VRAM
        let engine = null, isDownloading = false, modelLoaded = false, editingLoreIndex = -1, loadedModelId = null;
        let deviceRam = navigator.deviceMemory || 4;
        
        const $ = (id) => document.getElementById(id);
        const ui = {
            toast(msg, type='info') {
                const el = document.createElement('div');
                const styles = { error: 'bg-red-500/10 border-red-500/50 text-red-200', success: 'bg-green-500/10 border-green-500/50 text-green-200', info: 'bg-gray-800/90 border-gray-700 text-gray-200' };
                el.className = `p-3 rounded-lg border text-xs shadow-xl backdrop-blur fade-in pointer-events-auto flex items-center gap-2 transform transition-all duration-300 ${styles[type]||styles.info}`;
                el.innerHTML = `<i class="ri-${type==='error'?'error-warning':(type==='success'?'checkbox-circle':'information')}-line text-base"></i> <span class="font-medium">${msg}</span>`;
                $('toast-container').appendChild(el);
                setTimeout(() => { el.style.opacity='0'; el.style.transform='translateX(20px)'; setTimeout(()=>el.remove(), 300); }, 3000);
            },
            showLoader(show, title, text) {
                const l = $('loading-overlay');
                if(show) { l.classList.remove('hidden'); requestAnimationFrame(() => l.classList.remove('opacity-0')); if(title)$('loader-title').textContent=title; if(text)$('loader-text').textContent=text; } 
                else { l.classList.add('opacity-0'); setTimeout(() => l.classList.add('hidden'), 300); }
            },
            toggleFocus(active) {
                document.body.classList.toggle('focus-active', active);
                if(active) { $('main-header').classList.add('-translate-y-full'); $('floating-menu').classList.add('translate-y-20', 'opacity-0'); $('focus-exit-btn').classList.remove('hidden'); }
                else { $('main-header').classList.remove('-translate-y-full'); $('floating-menu').classList.remove('translate-y-20', 'opacity-0'); $('focus-exit-btn').classList.add('hidden'); }
            }
        };

        window.togglePanel = (show) => {
            const p = $('control-panel'), b = $('panel-backdrop');
            if(show) { b.classList.remove('hidden'); setTimeout(()=>b.classList.remove('opacity-0'), 10); p.classList.remove('closed'); p.classList.add('open'); } 
            else { b.classList.add('opacity-0'); p.classList.remove('open'); p.classList.add('closed'); setTimeout(()=>b.classList.add('hidden'), 300); }
        };

        async function loadState() {
            try {
                $('ram-badge').textContent = `RAM: ~${deviceRam}GB`;
                $('ram-welcome-msg').textContent = `System: ${deviceRam}GB RAM detected.`;
                const data = await get(DB_KEY);
                if (data) state = { ...state, ...data, sessions: data.sessions || {}, cloud: { ...state.cloud, ...data.cloud } };

                $('cloud-key-primary').value = state.cloud.primary || "";
                $('cloud-key-backup').value = state.cloud.backup || "";
                $('cloud-model-id').value = state.cloud.targetModel || "";
                $('cloud-endpoint').value = state.cloud.endpoint || ""; // LOAD ENDPOINT
                $('auto-detect-toggle').checked = state.cloud.autoDetect;
                $('ctx-slider').value = state.settings.contextStrategy;
                $('temp-slider').value = state.settings.temperature;
                $('temp-val').textContent = state.settings.temperature;
                
                updateContextUI(state.settings.contextStrategy);
                renderSessions();

                if (!state.currentSessionId || !state.sessions[state.currentSessionId]) createSession();
                else { renderChat(); renderLore(); }
                
                updateHeader();
                
                // AUTO LOAD LOGIC
                const activeId = state.settings.activeModelId;
                if(activeId && activeId !== 'cloud' && state.downloadedModels.includes(activeId)) {
                    ui.toast("Restoring active model...", "info");
                    await initEngine(activeId);
                }
            } catch (e) { console.error(e); ui.toast("Load Error", "error"); }
        }

        // --- CLOUD AUTO DETECT LOGIC ---
        window.detectAndFill = (key) => {
            if(!key || !$('auto-detect-toggle').checked) return;
            
            let provider = 'openrouter'; 
            let keyType = "Unknown";

            if(key.startsWith('AIza')) { provider = 'google'; keyType = "Google Gemini"; }
            else if(key.startsWith('sk-or-')) { provider = 'openrouter'; keyType = "OpenRouter"; }
            else if(key.startsWith('sk-')) { provider = 'deepseek'; keyType = "DeepSeek/Generic"; }

            // Auto-fill URL
            const endpoint = CLOUD_PROVIDERS[provider].url;
            $('cloud-endpoint').value = endpoint;
            
            // Populate Suggestions
            const models = CLOUD_PROVIDERS[provider].models;
            renderModelSuggestions(models);
            
            // Show toast
            ui.toast(`Detected: ${keyType}`, "success");
            
            // Open suggestions automatically
            showModelSuggestions(true);
        };

        function renderModelSuggestions(models) {
            const list = $('model-suggestions');
            list.innerHTML = models.map(m => 
                `<div onclick="selectCloudModel('${m}')" class="px-3 py-2 text-xs text-gray-300 hover:bg-blue-600/20 hover:text-blue-300 cursor-pointer transition border-b border-gray-800 last:border-0">
                    ${m}
                 </div>`
            ).join('');
        }

        window.selectCloudModel = (m) => {
            $('cloud-model-id').value = m;
            showModelSuggestions(false);
        };

        window.showModelSuggestions = (show) => {
            const el = $('model-suggestions');
            if(show && el.children.length > 0) el.classList.remove('hidden');
            else el.classList.add('hidden');
        };

        // --- LORE LOGIC ---
        function renderLore() {
            const l = $('lore-list'); l.innerHTML = '';
            (state.sessions[state.currentSessionId]?.lore || []).forEach((c,i) => {
                const d = document.createElement('div');
                d.className = "bg-gray-800/50 p-2.5 rounded-lg flex justify-between border border-gray-700 mb-2";
                d.innerHTML = `
                    <div class="overflow-hidden flex-1 cursor-pointer" onclick="editLore(${i})">
                        <div class="text-xs font-bold text-purple-400 flex items-center gap-2">${c.name} <i class="ri-pencil-line text-gray-600 text-[10px]"></i></div>
                        <div class="text-[10px] text-gray-400 line-clamp-2">${c.description}</div>
                    </div>
                    <button class="text-gray-500 hover:text-red-400 px-1 ml-2" onclick="delLore(${i})"><i class="ri-close-circle-line"></i></button>`;
                l.appendChild(d);
            });
            if(editingLoreIndex === -1) resetLoreForm();
        }

        window.editLore = (i) => {
            const item = state.sessions[state.currentSessionId].lore[i];
            $('lore-name-input').value = item.name;
            $('lore-desc-input').value = item.description;
            $('add-lore-btn').textContent = "Update Card";
            $('cancel-lore-btn').classList.remove('hidden');
            $('lore-header-text').textContent = "Editing Card";
            editingLoreIndex = i;
        };

        function resetLoreForm() {
            $('lore-name-input').value = '';
            $('lore-desc-input').value = '';
            $('add-lore-btn').textContent = "Add to Context";
            $('cancel-lore-btn').classList.add('hidden');
            $('lore-header-text').textContent = "Create Persona Card";
            editingLoreIndex = -1;
        }

        $('add-lore-btn').onclick = () => {
            const n = $('lore-name-input').value.trim(), d = $('lore-desc-input').value.trim();
            if(!n) return;
            const session = state.sessions[state.currentSessionId];
            if(editingLoreIndex > -1) session.lore[editingLoreIndex] = { name: n, description: d };
            else session.lore.push({ name: n, description: d });
            saveState(); resetLoreForm(); renderLore();
        };
        $('cancel-lore-btn').onclick = resetLoreForm;
        window.delLore = (i) => { state.sessions[state.currentSessionId].lore.splice(i,1); saveState(); renderLore(); };

        // --- MODEL RENDERING ---
        function updateContextUI(val) {
            const labels = ["MINIMAL", "SAFE", "ULTIMATE"];
            $('ctx-label').textContent = labels[val];
            $('ctx-label').className = `font-mono font-bold text-xs ${val==2?'text-red-500':(val==1?'text-blue-400':'text-gray-400')}`;
            state.settings.contextStrategy = parseInt(val); saveState(); renderModels();
        }

        function renderModels() {
             let html = "";
             const strategy = state.settings.contextStrategy;
             OFFLINE_MODELS.forEach(m => {
                 const currentCtxLimit = m.limits[strategy];
                 let effectiveReqRam = m.reqRam + (strategy === 2 && m.limits[2] > 8192 ? 2 : 0);
                 const isSafe = deviceRam >= effectiveReqRam;
                 const isDownloaded = state.downloadedModels.includes(m.id);
                 const isActive = state.settings.activeModelId === m.id;

                 let border = isActive ? 'border-green-500/50 bg-green-900/10' : (isSafe ? 'border-gray-700 bg-gray-900/20' : 'border-red-900/50 bg-red-900/5');
                 let badge = isActive ? 'bg-green-900/30 text-green-300' : (isSafe ? 'bg-gray-800 text-gray-400' : 'bg-red-900/20 text-red-400');
                 let warning = (strategy === 2 && currentCtxLimit > 10000) ? `<i class="ri-fire-fill text-orange-500 ml-1"></i>` : '';

                 html += `
                    <div class="p-3 rounded-xl border ${border} transition relative hover:border-opacity-100">
                        <div class="flex justify-between items-center mb-1">
                            <div>
                                <div class="text-xs font-bold text-gray-200">${m.name}</div>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    <span class="text-[9px] px-1.5 py-0.5 rounded border border-white/5 ${badge} font-mono">Req:${m.reqRam}GB</span>
                                    <span class="text-[9px] px-1.5 py-0.5 rounded border border-gray-700 text-gray-400 font-mono">Ctx:${currentCtxLimit}${warning}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${isDownloaded ? 
                                    `<button class="w-8 h-8 rounded-full bg-gray-800 hover:bg-red-900/50 hover:text-red-400 flex items-center justify-center transition border border-gray-700" onclick="window.deleteLocal('${m.id}')"><i class="ri-delete-bin-line"></i></button>
                                     <button class="px-4 py-1.5 text-xs font-bold rounded-lg transition shadow-lg ${isActive ? 'bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}" onclick="window.setActive('${m.id}')">${isActive?'Active':'Load'}</button>` 
                                    : `<button class="px-4 py-1.5 text-xs font-bold rounded-lg bg-blue-600 hover:bg-blue-500 text-white transition" onclick="window.downloadModel('${m.id}')"><i class="ri-download-cloud-line mr-1"></i> Get</button>`
                                }
                            </div>
                        </div>
                    </div>`;
             });
             $('offline-list').innerHTML = html;
        }

        async function initEngine(modelId) {
            // CHECK: If model is already loaded, skip reload
            if (modelId === loadedModelId && engine && modelLoaded) {
                 ui.toast("Model already ready", "success");
                 return;
            }

            const m = OFFLINE_MODELS.find(x => x.id === modelId);
            const limit = m.limits[state.settings.contextStrategy];
            ui.showLoader(true, `Loading ${m.name}`, `Context: ${limit} tokens`);
            try {
                if (!engine) engine = new webllm.MLCEngine();
                engine.setInitProgressCallback((r) => { $('loader-bar').style.width = (r.progress * 100) + '%'; $('loader-text').textContent = r.text; });
                await engine.reload(modelId, { context_window_size: limit, temperature: parseFloat(state.settings.temperature) });
                modelLoaded = true; 
                loadedModelId = modelId; // MARK: Set global loaded ID
                ui.toast(`Ready (${limit} ctx)`, "success");
            } catch (e) { 
                handleUnresponsive(e);
            } finally { ui.showLoader(false); }
        }

        async function downloadModel(id) {
            if(isDownloading) return; isDownloading = true;
            ui.showLoader(true, "Downloading Model", "Connecting...");
            try {
                if (!engine) engine = new webllm.MLCEngine();
                engine.setInitProgressCallback((r) => { $('loader-bar').style.width = (r.progress*100)+'%'; $('loader-text').textContent = r.text; });
                await engine.reload(id);
                if(!state.downloadedModels.includes(id)) state.downloadedModels.push(id);
                await saveState(); renderModels(); ui.toast("Download Complete", "success");
            } catch (e) { ui.toast("Error: " + e.message, "error"); } finally { ui.showLoader(false); isDownloading = false; }
        }

        // --- CHAT GENERATION & FALLBACK ---
        window.quickAction = (text) => { $('user-input').value = text; $('user-input').focus(); };

        async function generateResponse() {
            const inputEl = $('user-input'), txt = inputEl.value.trim();
            if (!txt) return;
            const session = state.sessions[state.currentSessionId], activeId = state.settings.activeModelId;
            if(!activeId) { ui.toast("Select a model in settings", "error"); togglePanel(true); switchTab('models'); return; }
            if(activeId !== 'cloud' && (!engine || !modelLoaded)) { ui.toast("Model not loaded", "error"); return; }

            inputEl.value = ''; const btn = $('send-btn'); btn.disabled = true; btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i>';
            session.history.push({ role: 'user', content: txt });
            appendMessage({ role: 'user', content: txt });
            const aiBubbleId = appendMessage({ role: 'assistant', content: '' }, true);

            try {
                let loreTxt = session.lore.map(l => `${l.name}: ${l.description}`).join('\n');
                let sys = (session.system || $('system-prompt-input').value || "You are a helpful AI.") + (loreTxt ? `\n\nCONTEXT:\n${loreTxt}` : "");
                let msgs = [{ role: "system", content: sys }, ...session.history.slice(0, -1)];

                let fullContent = "";
                if(activeId === 'cloud') {
                    fullContent = await callCloudWithFallback(msgs);
                    updateAiMessage(aiBubbleId, fullContent);
                } else {
                    const chunks = await engine.chat.completions.create({ messages: msgs, temperature: parseFloat(state.settings.temperature), stream: true });
                    let counter = 0;
                    for await (const chunk of chunks) {
                        fullContent += chunk.choices[0]?.delta?.content || "";
                        if(++counter % 2 === 0) updateAiMessage(aiBubbleId, fullContent, true);
                    }
                    updateAiMessage(aiBubbleId, fullContent);
                }
                session.history.push({ role: 'assistant', content: fullContent });
                if (session.history.length === 2 && session.name === "New Chat") { session.name = txt.substring(0, 30); renderSessions(); }
                await saveState();
            } catch (e) {
                document.getElementById(aiBubbleId)?.parentElement.remove();
                handleUnresponsive(e);
                inputEl.value = txt; 
            } finally { btn.disabled = false; btn.innerHTML = '<i class="ri-arrow-up-line text-xl"></i>'; }
        }

        async function callCloudWithFallback(messages) {
             const tryCall = async (key, isBackup=false) => {
                 if(!key) throw new Error("API Key Missing");
                 const prov = detectProvider(key);
                 let url, body, headers;
                 
                 // USE CUSTOM ENDPOINT IF AVAILABLE, ELSE AUTO-DETECT
                 let baseEndpoint = state.cloud.endpoint;
                 if(!baseEndpoint) baseEndpoint = prov === 'google' ? "https://generativelanguage.googleapis.com/v1beta/models" : (prov === 'openrouter' ? "https://openrouter.ai/api/v1/chat/completions" : "https://api.deepseek.com/chat/completions");

                 if(prov === 'google') {
                     const contents = messages.filter(m=>m.role!=='system').map(m=>({ role: m.role==='assistant'?'model':'user', parts: [{text: m.content}] }));
                     const sys = messages.find(m=>m.role==='system')?.content;
                     if(sys && contents.length) contents[0].parts[0].text = "System: "+sys+"\n\n"+contents[0].parts[0].text;
                     
                     let mName = state.cloud.targetModel.includes('/') ? state.cloud.targetModel.split('/')[1] : (state.cloud.targetModel || "gemini-2.0-flash-lite-preview-02-05");
                     
                     // Construct Google URL safely
                     if (baseEndpoint.includes(':generateContent')) url = `${baseEndpoint}?key=${key}`;
                     else url = `${baseEndpoint}/${mName}:generateContent?key=${key}`;

                     body = JSON.stringify({ contents }); headers = {'Content-Type': 'application/json'};
                 } else {
                     url = baseEndpoint; // Direct use for OpenAI compatible
                     headers = { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' };
                     if(prov === 'openrouter') { headers['HTTP-Referer'] = window.location.href; headers['X-Title'] = 'CWAI 1.2.5'; }
                     body = JSON.stringify({ model: state.cloud.targetModel || 'gpt-3.5-turbo', messages, temperature: parseFloat(state.settings.temperature) });
                 }
                 const res = await fetch(url, { method: 'POST', headers, body });
                 const d = await res.json();
                 if(!res.ok || d.error) throw new Error(d.error?.message || "API Error");
                 return prov === 'google' ? d.candidates[0].content.parts[0].text : d.choices[0].message.content;
             };
             try { return await tryCall(state.cloud.primary); } 
             catch(e) { if(state.cloud.backup) { ui.toast("Primary failed, using Backup...", "info"); return await tryCall(state.cloud.backup, true); } throw e; }
        }

        function handleUnresponsive(e) {
            ui.toast("Model Error: " + e.message, "error");
            togglePanel(true); switchTab('models');
            state.settings.activeModelId = null; updateHeader();
        }

        function detectProvider(key) { if(!state.cloud.autoDetect) return 'openrouter'; if(key.startsWith('AIza')) return 'google'; if(key.startsWith('sk-or-')) return 'openrouter'; if(key.startsWith('sk-')) return 'deepseek'; return 'openrouter'; }

        // --- SESSIONS (Updated 1.2.5 Logic) ---
        function renderSessions() {
            const list = $('session-list'); list.innerHTML = '';
            const term = $('session-search').value.toLowerCase();
            Object.values(state.sessions).sort((a,b)=>b.created-a.created).forEach(s => {
                if(term && !s.name.toLowerCase().includes(term)) return;
                const d = document.createElement('div');
                d.className = `p-3 rounded-lg flex justify-between items-center cursor-pointer mb-1 transition group ${s.id===state.currentSessionId ? 'bg-blue-600/20 border border-blue-500/30' : 'hover:bg-gray-800 border border-transparent'}`;
                d.innerHTML = `
                    <div class="overflow-hidden mr-2 flex-1"><div class="text-xs font-medium text-gray-200 truncate group-hover:text-white">${s.name}</div><div class="text-[10px] text-gray-500">${new Date(s.created).toLocaleDateString()}</div></div>
                    <div class="flex gap-1 pl-2">
                         <button class="rename-btn p-1.5 text-gray-500 hover:text-blue-300" title="Rename"><i class="ri-pencil-line"></i></button>
                         <button class="copy-btn p-1.5 text-gray-500 hover:text-green-300" title="Copy"><i class="ri-file-copy-line"></i></button>
                         <button class="del-btn p-1.5 text-gray-500 hover:text-red-400" title="Delete"><i class="ri-delete-bin-line"></i></button>
                    </div>`;
                d.onclick = (e) => {
                    e.stopPropagation();
                    const btn = e.target.closest('button');
                    if(btn) {
                        if(btn.classList.contains('del-btn')) { 
                            if(confirm('Delete chat permanently?')) { delete state.sessions[s.id]; if(s.id===state.currentSessionId) createSession(); else { saveState(); renderSessions(); } } 
                        }
                        else if(btn.classList.contains('copy-btn')) {
                            const newId = Date.now().toString(); state.sessions[newId] = {...s, id: newId, created: Date.now(), name: "Copy of " + s.name};
                            saveState(); renderSessions(); ui.toast("Chat Copied");
                        }
                        else if(btn.classList.contains('rename-btn')) {
                            const newName = prompt("Rename Chat:", s.name);
                            if(newName && newName.trim()) { state.sessions[s.id].name = newName.trim(); saveState(); renderSessions(); }
                        }
                        return;
                    }
                    state.currentSessionId = s.id; if(s.system) $('system-prompt-input').value = s.system; 
                    renderChat(); renderLore(); renderSessions(); if(window.innerWidth<768) togglePanel(false);
                };
                list.appendChild(d);
            });
        }

        // --- DOM RENDERERS ---
        function appendMessage(msg, isThinking=false) {
            const c = $('chat-container'); const isUser = msg.role === 'user';
            const div = document.createElement('div'); const id = 'msg-' + Date.now() + Math.random();
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-enter-message mb-6`;
            div.innerHTML = `<div id="${id}" class="max-w-[90%] md:max-w-[85%] px-5 py-3.5 text-sm shadow-md leading-relaxed ${isUser ? 'msg-user' : 'msg-ai'}">${isThinking ? '<div class="flex gap-1 py-1"><span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce delay-100"></span><span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce delay-200"></span></div>' : (isUser ? msg.content : marked.parse(msg.content))}</div>`;
            c.appendChild(div); scrollToBottom(); return id;
        }
        function updateAiMessage(id, content, streaming=false) {
            const el = document.getElementById(id); if(!el) return;
            el.innerHTML = `<div class="prose prose-invert">${marked.parse(content + (streaming ? ' ' : ''))}</div>`;
            if(!streaming) { el.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b)); addCopyButtons(el); }
            scrollToBottom();
        }
        function addCopyButtons(el) { el.querySelectorAll('pre').forEach(pre => { if(pre.querySelector('.copy-code-btn')) return; const btn = document.createElement('button'); btn.className='copy-code-btn'; btn.textContent='Copy'; btn.onclick = () => { navigator.clipboard.writeText(pre.querySelector('code').innerText); btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy',2000); }; pre.appendChild(btn); }); }
        function scrollToBottom() { const c = $('chat-container'); if(c.scrollHeight - c.scrollTop - c.clientHeight < 200) c.scrollTop = c.scrollHeight; }

        // --- EXPORTS & EVENTS ---
        function createSession() { const id = Date.now().toString(); state.sessions[id] = { id, name: "New Chat", history: [], created: Date.now(), system: "", lore: [] }; state.currentSessionId = id; saveState(); renderSessions(); renderChat(); renderLore(); }
        async function saveState() { await set(DB_KEY, state); }

        window.setActive = async (id) => { state.settings.activeModelId = id; await saveState(); renderModels(); updateHeader(); if(id!=='cloud') await initEngine(id); else ui.toast("Cloud Active"); };
        window.deleteLocal = async (id) => { if(confirm("Delete cache?")) { state.downloadedModels = state.downloadedModels.filter(x=>x!==id); if(state.settings.activeModelId===id) state.settings.activeModelId=null; await saveState(); renderModels(); updateHeader(); }};
        window.downloadModel = downloadModel;
        
        function updateHeader() {
            const mId = state.settings.activeModelId; const n = $('current-model-name'); const d = $('status-dot');
            if(!mId) { n.textContent = "Select Model"; d.className = "w-1.5 h-1.5 rounded-full bg-red-500"; }
            else if (mId === 'cloud') { n.textContent = `Cloud (${detectProvider(state.cloud.primary)})`; d.className = "w-1.5 h-1.5 rounded-full bg-blue-400"; }
            else { const m = OFFLINE_MODELS.find(x=>x.id===mId); n.textContent = m?m.name:"Local"; d.className = "w-1.5 h-1.5 rounded-full bg-green-500"; }
        }

        // --- UPDATED TAB SWITCHING WITH ANIMATION ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => { 
                b.classList.remove('text-blue-400', 'active-tab'); 
                b.classList.add('text-gray-500'); 
                if(b.dataset.tab===tabName) { b.classList.add('text-blue-400', 'active-tab'); b.classList.remove('text-gray-500'); } 
            });
            
            // Hide all tabs
            ['models','lore','data','system'].forEach(t => {
                const el = $(`tab-${t}`);
                el.classList.add('hidden');
                el.classList.remove('animate-slide-in'); // Reset animation
            });
            
            // Show new tab with animation
            const target = $(`tab-${tabName}`);
            target.classList.remove('hidden');
            // Trigger reflow to restart animation
            void target.offsetWidth; 
            target.classList.add('animate-slide-in');
        }

        $('send-btn').onclick = generateResponse;
        $('user-input').onkeydown = (e) => { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(); generateResponse();} };
        $('header-menu-btn').onclick = () => { renderModels(); renderSessions(); togglePanel(true); };
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = () => switchTab(btn.dataset.tab));

        $('ctx-slider').oninput = (e) => updateContextUI(e.target.value);
        $('temp-slider').oninput = (e) => { $('temp-val').textContent = e.target.value; state.settings.temperature = e.target.value; };
        
        $('activate-cloud-btn').onclick = () => { 
            state.cloud.primary=$('cloud-key-primary').value.trim(); 
            state.cloud.backup=$('cloud-key-backup').value.trim(); 
            state.cloud.targetModel=$('cloud-model-id').value.trim(); 
            state.cloud.endpoint=$('cloud-endpoint').value.trim(); // SAVE ENDPOINT
            state.cloud.autoDetect=$('auto-detect-toggle').checked; 
            window.setActive('cloud'); 
        };

        $('float-toggle-btn').onclick = () => { const i=$('floating-items'), b=$('float-toggle-btn').querySelector('i'); if(i.classList.contains('pointer-events-none')){ i.classList.remove('opacity-0','translate-y-4','pointer-events-none','scale-95'); b.classList.add('rotate-45'); } else { i.classList.add('opacity-0','translate-y-4','pointer-events-none','scale-95'); b.classList.remove('rotate-45'); }};
        $('float-new-btn').onclick = () => { createSession(); $('float-toggle-btn').click(); };
        
        $('float-voice-btn').onclick = () => { state.settings.tts = !state.settings.tts; ui.toast(state.settings.tts?"Voice On":"Voice Off"); };
        $('mic-btn').onclick = () => {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(!SR) return ui.toast("No Voice Support","error");
            const r = new SR(); r.continuous=false; r.onstart=()=>$('mic-btn').classList.add('text-red-500','animate-pulse'); r.onend=()=>$('mic-btn').classList.remove('text-red-500','animate-pulse');
            r.onresult=(e)=>$('user-input').value+=(($('user-input').value?' ':'')+e.results[0][0].transcript); r.start();
        };

        // --- NEW: SERVICE WORKER UPDATE HANDLER ---
        let newWorker;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                reg.addEventListener('updatefound', () => {
                    newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Show Update Toast
                            const t = $('update-toast');
                            t.classList.remove('translate-y-20', 'opacity-0', 'pointer-events-none');
                        }
                    });
                });
            });
        }
        $('update-btn').onclick = () => { if(newWorker) newWorker.postMessage('SKIP_WAITING'); window.location.reload(); };

        window.onload = loadState;
    </script>
</body>
</html>
